# Bug Fix: Bilibili 实时流式传输 403 Forbidden 错误

## 基本信息

| 项目 | 内容 |
|------|------|
| **发现时间** | 2026-01-07 14:23 (UTC+8) |
| **解决时间** | 2026-01-07 14:25 (UTC+8) |
| **修复耗时** | 约 2 分钟 |
| **影响范围** | Bilibili 视频实时流式播放功能 |
| **严重程度** | 高 |

---

## Bug 描述

### 现象

新实现的 Bilibili 实时流式代理功能无法正常工作：
1. FFmpeg 进程尝试访问视频/音频流时返回 403 Forbidden 错误
2. 后端日志显示 FFmpeg 进程以 exit code 1 退出
3. 前端视频播放器无法加载内容

### 复现步骤

1. 导入一个 Bilibili 视频 URL
2. 点击播放视频
3. 观察后端日志，发现 403 错误

---

## 根本原因分析

问题由 **Bilibili CDN 防盗链机制** 导致。

Bilibili 的 CDN 服务器会检查请求的 HTTP 头部：
- `Referer`: 必须来自 `bilibili.com` 域名
- `User-Agent`: 必须是有效的浏览器标识

FFmpeg 默认不发送这些头部，导致 CDN 拒绝请求：

```
# yt-dlp 获取的 URL 格式
https://cn-xxx.bilivideo.com/...?deadline=xxx&gen=xxx&sign=xxx...

# FFmpeg 直接访问时缺少必要的 HTTP 头部
ffmpeg -i <video_url> -i <audio_url> ...  # ❌ 403 Forbidden
```

---

## 修复方案

### 修复: 添加 HTTP 头部到 FFmpeg 命令

**文件**: `backend/routes/streaming.py`

为 FFmpeg 命令添加 `-headers` 参数，传入 Referer 和 User-Agent：

```python
async def ffmpeg_stream_generator(video_url: str, audio_url: str):
    """Generator that yields chunks from FFmpeg's stdout."""
    # HTTP headers for Bilibili CDN (防盗链)
    http_headers = (
        "Referer: https://www.bilibili.com\r\n"
        "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
    )

    ffmpeg_cmd = [
        "ffmpeg",
        "-hide_banner",
        "-loglevel", "error",
        # HTTP headers for video input
        "-headers", http_headers,
        "-i", video_url,
        # HTTP headers for audio input (need to specify again)
        "-headers", http_headers,
        "-i", audio_url,
        # ... rest of command
    ]
```

**关键点**：
1. 头部需要用 `\r\n` 分隔（HTTP 协议规范）
2. 每个 `-i` 输入前都需要指定 `-headers`（FFmpeg 对每个输入单独处理）
3. Referer 必须是 `https://www.bilibili.com`

---

## 技术要点

### Bilibili 防盗链机制

Bilibili 使用多层防盗链保护：

| 层级 | 机制 | 绕过方式 |
|------|------|----------|
| URL 签名 | `sign`, `deadline` 参数 | yt-dlp 自动处理 |
| Referer 检查 | 验证来源域名 | `-headers "Referer: ..."` |
| User-Agent 检查 | 验证浏览器标识 | `-headers "User-Agent: ..."` |

### FFmpeg -headers 语法

```bash
# 正确格式（多个头部用 \r\n 分隔）
ffmpeg -headers "Header1: value1\r\nHeader2: value2" -i <url>

# 每个输入需要单独指定
ffmpeg -headers "..." -i <input1> -headers "..." -i <input2>
```

---

## 验证步骤

1. 启动后端服务 `uvicorn main:app --reload`
2. 导入 Bilibili 视频
3. 播放视频，确认：
   - 后端日志显示 FFmpeg 正常启动
   - 视频在前端正常播放
   - 无 403 错误

---

## 相关文件

| 文件 | 修改类型 |
|------|----------|
| `backend/routes/streaming.py` | 修改 |

---

## 后续优化建议

1. **头部配置化**: 将 Referer 和 User-Agent 提取到配置文件
2. **错误处理增强**: 检测 403 错误并给用户友好提示
3. **备用方案**: 如果实时流失败，回退到下载后播放模式
