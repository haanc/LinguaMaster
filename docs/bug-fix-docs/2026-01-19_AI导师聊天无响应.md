# Bug Fix: AI 导师聊天功能无响应

## 基本信息

| 项目 | 内容 |
|------|------|
| **发现时间** | 2026-01-19 22:40 (UTC+8) |
| **解决时间** | 2026-01-19 22:48 (UTC+8) |
| **修复耗时** | 约 8 分钟 |
| **影响范围** | 互动字幕 AI 导师聊天功能 |
| **严重程度** | 高 |

---

## Bug 描述

### 现象
用户在互动字幕 AI 导师面板中输入消息（如"给我解释AKS"、"HELLO"），发送后只显示空白的灰色气泡，没有任何 AI 响应内容。

### 复现步骤
1. 打开 LinguaMaster 应用（安装版本）
2. 进入任意视频的学习界面
3. 打开 AI 导师面板
4. 输入任意消息并发送
5. 观察到消息发送后只显示空白气泡，无文字内容

---

## 根本原因分析

问题的根本原因是 **后端 AI 服务未正确初始化**。

详细分析：

1. **AI 服务初始化失败**：后端 `AIService` 类在启动时会初始化 LangChain 组件（包括 `tutor_graph`）。如果初始化过程中出现任何异常，`self.tutor_graph` 会保持为 `None`。

2. **静默错误处理**：当调用 `/ai/chat` 端点时，`chat_with_tutor` 方法检测到 `self.tutor_graph` 为 `None`，返回 `{"error": "AI Service not initialized"}`。

3. **前端未正确处理错误**：前端收到包含 `error` 字段的响应后，没有正确提取错误信息并显示给用户，导致显示空白内容。

4. **可能的初始化失败原因**：
   - 后端进程异常终止后重启时环境变量未正确加载
   - `.env` 配置文件读取问题
   - LangChain 依赖模块导入失败

---

## 修复方案

### 修复 1: 重启后端服务

由于问题是服务初始化状态问题，**重启应用**可以解决：

1. 完全关闭 LinguaMaster 应用（包括托盘图标）
2. 重新启动应用
3. Electron 会重新启动后端 Python 进程，触发完整的初始化流程

验证初始化成功的日志：
```
Whisper Provider: Azure Whisper (whisper)
LLM Provider: Azure OpenAI (gpt-5.2-chat)
LangChain Agents initialized successfully.
```

### 修复 2: 验证 Azure OpenAI 配置

确认 `backend/.env` 中有正确的 Azure OpenAI 配置：

```ini
AZURE_OPENAI_ENDPOINT=https://xxx.openai.azure.com
AZURE_OPENAI_API_KEY=your-api-key
AZURE_OPENAI_DEPLOYMENT_CHAT=gpt-5.2-chat
```

**注意**：`gpt-5.2-chat` 是推理模型（reasoning model），代码已正确处理其特殊参数要求（不传递 `temperature` 参数）。

---

## 技术要点

### 1. 推理模型参数限制

Azure OpenAI 的推理模型（如 `o1-preview`、`o1-mini`、`gpt-5.2-chat`、`o3-mini`）有特殊的 API 参数限制：

- **不支持 `max_tokens`**：必须使用 `max_completion_tokens`
- **不支持 `temperature`**：只接受默认值

代码中已在 `backend/ai/providers/llm.py` 处理：

```python
# Models that only support temperature=1 (reasoning models)
FIXED_TEMPERATURE_MODELS = {"o1-preview", "o1-mini", "o1", "gpt-5.2-chat", "o3-mini"}

# 对推理模型不传递 temperature 参数
if supports_temperature:
    return AzureChatOpenAI(..., temperature=temperature)
else:
    return AzureChatOpenAI(...)  # 不传 temperature
```

### 2. AI 导师设计限制

AI 导师被设计为**只回答与选中字幕相关的问题**。如果没有选中字幕文本作为上下文，它会返回：

> "I can only answer questions related to the selected text. Please use other tools for general inquiries."

这是预期行为，不是 bug。

### 3. 服务初始化检查

`ai_service.py` 中的初始化逻辑：

```python
if LANGCHAIN_AVAILABLE:
    try:
        self.dictionary_chain = get_dictionary_chain()
        self.tutor_graph = create_tutor_graph()
        print("LangChain Agents initialized successfully.")
    except Exception as e:
        print(f"ERROR: Failed to initialize LangChain Agents: {e}")
```

---

## 验证步骤

1. 完全关闭并重启 LinguaMaster 应用
2. 打开任意视频的学习界面
3. 选中一段字幕文本
4. 打开 AI 导师面板
5. 输入问题（如"请解释这句话的语法"）
6. 确认收到 AI 的文字响应

---

## 相关文件

| 文件 | 说明 |
|------|------|
| `backend/ai_service.py` | AI 服务主类，包含 tutor 聊天逻辑 |
| `backend/ai/graph.py` | LangGraph 工作流定义 |
| `backend/ai/providers/llm.py` | LLM 提供者抽象层 |
| `backend/.env` | Azure OpenAI 配置文件 |
| `src/components/TutorPanel.tsx` | 前端 AI 导师 UI 组件 |
| `src/components/SubtitleSidebar.tsx` | 包含 handleSendMessage 逻辑 |

---

## 后续优化建议

1. **改进前端错误处理**：当 API 返回 `{"error": ...}` 时，前端应该显示友好的错误提示而不是空白内容

2. **添加健康检查**：在 `/health` 端点中返回各组件的初始化状态，方便诊断

3. **启动重试机制**：如果 LangChain 初始化失败，可以在首次调用时尝试重新初始化

4. **用户提示优化**：当没有选中字幕时，AI 导师面板应该提示用户"请先选中字幕文本"
