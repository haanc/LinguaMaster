# Bug Fix: Windows 路径含空格导致 Python 后端启动失败

## 基本信息

| 项目 | 内容 |
|------|------|
| **发现时间** | 2026-01-18 18:00 (UTC+8) |
| **解决时间** | 2026-01-18 20:10 (UTC+8) |
| **修复耗时** | 约 130 分钟 |
| **影响范围** | 应用启动、后端服务 |
| **严重程度** | 高 |
| **修复版本** | v0.0.4 |

---

## Bug 描述

### 现象
应用安装到 `C:\Program Files\LinguaMaster\` 目录后，后端 Python 进程无法启动，前端显示 "Backend failed with code 1"。

错误日志显示：
```
python.exe: can't open file 'C:\Program': [Errno 2] No such file or directory
```

### 复现步骤
1. 打包 Electron 应用（v0.0.3 或更早版本）
2. 使用 NSIS 安装器将应用安装到默认的 `C:\Program Files\LinguaMaster\` 目录
3. 启动应用
4. 观察到后端无法启动，应用功能不可用

---

## 根本原因分析

在 `electron/main.ts` 中，使用 Node.js 的 `spawn()` 函数启动 Python 后端时，路径参数没有正确处理包含空格的情况：

```typescript
// 问题代码
pyProcess = spawn(pythonPath, [scriptPath], {
    env: backendEnv,
    cwd: backendDir,
});
```

当 `pythonPath` 为 `C:\Program Files\LinguaMaster\resources\backend-dist\python\python.exe` 时，由于路径中包含空格，`spawn()` 会将路径在空格处截断，导致实际尝试执行的是 `C:\Program`，这个路径不存在。

这是 Windows 系统上使用 `spawn()` 的常见陷阱：不带 `shell: true` 选项时，路径中的空格不会被正确处理。

---

## 修复方案

### 修复: 使用 shell 模式并引用路径

**文件**: `electron/main.ts`

```typescript
try {
    // Use shell: true on Windows to properly handle paths with spaces
    // The paths are wrapped in quotes to prevent shell interpretation issues
    pyProcess = spawn(`"${pythonPath}"`, [`"${scriptPath}"`], {
        env: backendEnv,
        cwd: backendDir,
        shell: true,
        windowsHide: true,
    })
```

**修复要点：**
1. 添加 `shell: true` 选项，让命令通过 shell 执行
2. 用双引号包裹 `pythonPath` 和 `scriptPath`，确保空格被正确处理
3. 添加 `windowsHide: true` 防止显示控制台窗口

---

## 技术要点

### Node.js spawn() 的路径处理

- **不带 shell 模式**: 参数直接传递给目标程序，空格不会被特殊处理，但路径必须不含空格
- **带 shell 模式**: 命令通过 cmd.exe（Windows）或 /bin/sh（Unix）执行，需要正确引用包含空格的路径

### Windows 路径最佳实践

在 Windows 上处理可能包含空格的路径时：
1. 始终使用 `shell: true` 配合引号
2. 或者确保路径不包含空格（例如使用 8.3 短名称）
3. 测试时应覆盖包含空格的安装路径

---

## 验证步骤

1. 运行 `npm run build:full` 生成新的安装包
2. 将应用安装到 `C:\Program Files\LinguaMaster\`（默认路径）
3. 启动应用
4. 确认后端成功启动（前端显示 "Backend ready" 或可正常使用功能）
5. 检查 Python 进程是否正在运行

---

## 相关文件

| 文件 | 修改类型 |
|------|----------|
| `electron/main.ts` | 修改 |
| `package.json` | 修改（版本号更新至 0.0.4）|

---

## 后续优化建议

1. **安装路径建议**: 考虑将默认安装路径改为用户目录（如 `%LOCALAPPDATA%\LinguaMaster`），避免权限问题和空格问题
2. **错误提示优化**: 当后端启动失败时，显示更具体的错误信息帮助用户排查
3. **单元测试**: 添加针对包含空格路径的测试用例
