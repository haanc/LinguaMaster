# Bug Fix: 前端布局系统重构 - 侧边栏无法正常显示

## 基本信息

| 项目 | 内容 |
|------|------|
| **发现时间** | 2026-01-06 17:05 (UTC+8) |
| **解决时间** | 2026-01-06 23:07 (UTC+8) |
| **修复耗时** | 约 360 分钟 |
| **影响范围** | 整个应用的主布局系统，包括视频播放区和字幕侧边栏 |
| **严重程度** | 高 |

---

## Bug 描述

### 现象
1. 右侧字幕侧边栏被压缩到几乎不可见（只能看到 "Int..." 和 "Sub..."）
2. 无法通过拖动调整大小手柄来改变侧边栏宽度
3. 中间主区域占据了几乎全部空间
4. 视频播放时视频大小异常（过大或过小）

### 复现步骤
1. 启动应用
2. 观察右侧字幕侧边栏 - 发现被压缩到几乎看不见
3. 尝试拖动中间的调整大小手柄 - 无法调整
4. 播放视频 - 视频大小显示异常

---

## 根本原因分析

### 问题 1: react-resizable-panels 库的 API 变化
该项目使用 `react-resizable-panels` v4.2.2，但代码中的导入和属性名称与库的实际 API 不完全匹配：
- 虽然 `Group` 和 `Separator` 是有效的导出，但库的内部样式处理可能与项目的 CSS 冲突
- Panel 组件的 flex 布局与其他 CSS 样式产生了冲突

### 问题 2: CSS 布局冲突
- `.player-section` 使用 `flex: 1` 导致子元素撑开父容器
- 缺少 `min-width: 0` 导致 flex 子元素无法正确收缩
- Panel 组件的百分比尺寸无法正确应用

### 问题 3: 复杂的嵌套结构
- react-resizable-panels 的布局控制与自定义 CSS 样式相互干扰
- 多层嵌套的 flex 容器导致布局计算异常

---

## 修复方案

### 修复 1: 移除 react-resizable-panels，改用原生 CSS Flexbox

**文件**: `src/App.tsx`

```tsx
// 修改前 - 使用 react-resizable-panels
<div style={{ flex: 1, display: 'flex', overflow: 'hidden' }}>
  <PanelGroup orientation="horizontal">
    <Panel defaultSize={75} minSize={30}>
      {/* 主内容 */}
    </Panel>
    <PanelResizeHandle />
    <Panel defaultSize={25} minSize={15}>
      {/* 侧边栏 */}
    </Panel>
  </PanelGroup>
</div>

// 修改后 - 使用原生 Flexbox
<div className="main-layout">
  <div className="main-panel">
    {/* 主内容 */}
  </div>
  <div className="resize-handle" onMouseDown={handleResizeMouseDown}></div>
  <div className="sidebar-panel" style={{ width: sidebarWidth }}>
    {/* 侧边栏 */}
  </div>
</div>
```

使用原生 Flexbox 布局更简单直接，避免了库的复杂性和潜在的兼容性问题。

### 修复 2: 实现自定义拖动调整大小功能

**文件**: `src/App.tsx`

```tsx
// 添加状态和 ref
const [sidebarWidth, setSidebarWidth] = useState<number>(320);
const isResizing = useRef<boolean>(false);

// 添加鼠标事件处理
const handleResizeMouseDown = useCallback((e: React.MouseEvent) => {
  e.preventDefault();
  isResizing.current = true;
  document.body.style.cursor = 'col-resize';
  document.body.style.userSelect = 'none';
}, []);

useEffect(() => {
  const handleMouseMove = (e: MouseEvent) => {
    if (!isResizing.current) return;
    const newWidth = window.innerWidth - e.clientX;
    setSidebarWidth(Math.max(250, Math.min(600, newWidth)));
  };

  const handleMouseUp = () => {
    if (isResizing.current) {
      isResizing.current = false;
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
    }
  };

  document.addEventListener('mousemove', handleMouseMove);
  document.addEventListener('mouseup', handleMouseUp);

  return () => {
    document.removeEventListener('mousemove', handleMouseMove);
    document.removeEventListener('mouseup', handleMouseUp);
  };
}, []);
```

### 修复 3: 添加 CSS 布局样式

**文件**: `src/App.css`

```css
/* Main Layout - Flexbox based */
.main-layout {
  flex: 1;
  display: flex;
  overflow: hidden;
  height: 100%;
}

.main-panel {
  flex: 1;
  min-width: 0;
  height: 100%;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.resize-handle {
  width: 6px;
  background: transparent;
  cursor: col-resize;
  flex-shrink: 0;
}

.resize-handle:hover {
  background: rgba(99, 102, 241, 0.3);
}

.sidebar-panel {
  width: 320px;
  min-width: 280px;
  max-width: 500px;
  flex-shrink: 0;
  height: 100%;
  overflow: hidden;
  border-left: 1px solid var(--border-subtle);
}
```

关键点是 `min-width: 0` 允许 flex 子元素正确收缩。

### 修复 4: 修复视频播放器样式

**文件**: `src/App.css`

```css
.player-section {
  width: 100%;
  height: 100%;
  min-width: 0;
  min-height: 0;
  background: #000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 8px;
  overflow: hidden;
  box-sizing: border-box;
}

.main-video {
  width: 100%;
  height: 100%;
  object-fit: contain;
  border-radius: 8px;
}
```

---

## 技术要点

1. **Flexbox 的 min-width: 0**: 在 flex 容器中，子元素默认的 `min-width` 是 `auto`，这会阻止元素收缩到其内容以下。设置 `min-width: 0` 可以解决这个问题。

2. **拖动调整大小的实现**: 通过监听 `mousedown`、`mousemove`、`mouseup` 事件，在拖动时计算新的宽度并更新状态。

3. **视频 object-fit**: 使用 `object-fit: contain` 可以让视频在保持宽高比的情况下适应容器大小。

---

## 验证步骤

1. 启动应用，确认右侧字幕侧边栏正常显示（宽度约 320px）
2. 将鼠标悬停在侧边栏左边缘，确认光标变为 col-resize
3. 拖动边缘，确认可以调整侧边栏宽度（范围 250px-600px）
4. 播放视频，确认视频大小正常，能够自适应容器
5. 切换到 Library 和 Notebook 视图，确认布局正常

---

## 相关文件

| 文件 | 修改类型 |
|------|----------|
| `src/App.tsx` | 修改 - 重构布局结构，添加拖动调整功能 |
| `src/App.css` | 修改 - 添加新的布局样式 |
| `src/components/LibraryGrid.css` | 修改 - 调整容器样式 |
| `src/components/NotebookView.css` | 修改 - 调整容器样式 |

---

## 后续优化建议

1. 考虑将侧边栏宽度保存到 localStorage，以便下次打开时恢复
2. 可以添加双击调整手柄恢复默认宽度的功能
3. 在窗口大小变化时自动调整侧边栏宽度比例
