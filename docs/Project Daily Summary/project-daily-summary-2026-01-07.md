# 项目每日进展总结

> 📅 日期：2026-01-07
> 🕐 记录时间：16:45 (UTC+8)
> 📁 项目：Fluent Learner v2

---

## 📊 今日概览

| 类别 | 数量 |
|------|------|
| 新增功能 | 1 |
| 架构调整 | 1 |
| Bug 修复 | 2 |
| 规划任务 | 1 |

---

## 🚀 新增功能

### 1. Bilibili 实时流式代理播放

| 项目 | 内容 |
|------|------|
| **开始时间** | 14:00 |
| **完成时间** | 14:26 |
| **耗时** | 约 26 分钟 |

**功能描述：**
将 Bilibili 视频播放从"完整下载后播放"改为"实时流式代理播放"，大幅减少用户等待时间。

**实现方式：**
- 技术栈：Python + FFmpeg + FastAPI StreamingResponse
- 关键实现：
  - 使用 yt-dlp 提取视频和音频直接 URL
  - FFmpeg 实时合并音视频流（`-movflags frag_keyframe+empty_moov+faststart`）
  - 64KB 分块流式输出
  - 添加 Bilibili CDN 防盗链头部（Referer + User-Agent）

**技术架构：**
```
yt-dlp (获取 URL) → FFmpeg (实时合并) → StreamingResponse → 前端播放器
```

**预期效果：**
| 指标 | 旧方案 | 新方案 |
|------|--------|--------|
| 首次加载时间 | 1-2 分钟 | 10-20 秒 |
| 视频存储 | 完整缓存 | 无 |
| 用户体验 | 需等待下载 | 边下边播 |

**涉及文件：**
| 文件 | 修改类型 |
|------|----------|
| `backend/routes/streaming.py` | 新增端点 + 辅助函数 |
| `src/App.tsx` | 修改 Bilibili 播放逻辑 |

---

## 🏗️ 架构调整

### 1. 音频切片并行转录方案规划

| 项目 | 内容 |
|------|------|
| **时间** | 16:30 |

**调整内容：**
规划解决 Whisper API 25MB 限制的方案，添加到项目 task.md 作为高优先级任务。

**技术方案：**
```
yt-dlp (流式下载) → FFmpeg (实时切片) → Whisper x N (并行转录) → 合并结果
```

**预期效果：**
| 视频时长 | 当前方案 | 优化后 |
|---------|---------|-------|
| 15 分钟 | ~5.5 min | ~2 min |
| 1 小时 | ❌ 超限 | ~6-8 min |
| 2 小时 | ❌ 不可用 | ~10-12 min |

**涉及文件：**
- `docs/task.md`（添加高优先级任务）

---

## 🐛 Bug 修复

### 1. AuthModal 登录表单输入框样式异常

| 项目 | 内容 |
|------|------|
| **发现时间** | 10:14 |
| **修复时间** | 10:52 |
| **修复耗时** | 38 分钟 |
| **严重程度** | 中 |
| **影响范围** | 登录/注册模态框的用户界面 |

**问题概述：**
登录表单中的 Email 和 Password 输入框存在样式问题：
- 输入框右侧出现深色分割区块
- 两个输入框宽度不一致
- 标签文字被截断

**根本原因：**
CSS 类名冲突 - `EmptyState.css` 中的全局 `.input-group` 样式覆盖了 AuthModal 的内联样式。

**修复方案：**
1. 将类名从 `input-group` 改为 `auth-input-group`
2. 重构输入框布局为 Flex 容器 + 子元素结构
3. 新建 `AuthModal.css` 处理浏览器 autofill 样式覆盖

**📄 详细文档：** [查看完整修复记录](../bug-fix-docs/2026-01-07_AuthModal登录表单输入框样式异常.md)

---

### 2. Bilibili 实时流式传输 403 Forbidden 错误

| 项目 | 内容 |
|------|------|
| **发现时间** | 14:23 |
| **修复时间** | 14:25 |
| **修复耗时** | 2 分钟 |
| **严重程度** | 高 |
| **影响范围** | Bilibili 视频实时流式播放功能 |

**问题概述：**
新实现的 Bilibili 实时流式代理功能无法工作，FFmpeg 访问视频/音频流时返回 403 Forbidden。

**根本原因：**
Bilibili CDN 防盗链机制要求请求必须包含有效的 `Referer` 和 `User-Agent` HTTP 头部。

**修复方案：**
为 FFmpeg 命令添加 `-headers` 参数：
```python
http_headers = "Referer: https://www.bilibili.com\r\nUser-Agent: Mozilla/5.0..."
ffmpeg_cmd = [..., "-headers", http_headers, "-i", video_url, ...]
```

**📄 详细文档：** [查看完整修复记录](../bug-fix-docs/2026-01-07_Bilibili实时流式传输403错误.md)

---

## 📋 后续待办

### 高优先级
- [ ] 实现音频切片转录 Phase 1（解决 25MB 限制）
- [ ] 实现并行 Whisper 转录 Phase 2（加速处理）

### 中优先级
- [ ] 实现微信扫码登录
- [ ] 配置 Windows 平台 Electron Builder

### 低优先级
- [ ] 学前复习提醒功能
- [ ] 学习数据统计（热力图）

---

## 📈 相关统计

| 指标 | 数值 |
|------|------|
| 总工作时长 | 约 4 小时 |
| 代码文件变更 | 4 个 |
| Bug 修复文档 | 2 个 |
| 新增功能 | 1 个（Bilibili 实时流） |

---

## 📝 今日重要决策

### 采用方案 C 实现 Bilibili 流式播放

**决策时间：** 14:00

**决策内容：**
选择"FFmpeg 实时合并视频+音频流"方案（方案 C），而非 iframe 嵌入（方案 B）。

**决策理由：**
- 方案 B（iframe）无法支持字幕同步
- 方案 C 保持完整的播放器控制和字幕功能
- 实时流式传输减少用户等待时间

---

### 确定音频切片并行转录为下一开发重点

**决策时间：** 16:30

**决策内容：**
将音频切片并行转录方案加入 task.md 作为高优先级开发任务。

**决策理由：**
- Whisper API 25MB 限制导致超过 17-18 分钟的视频无法转录
- 切片并行可同时解决时长限制和速度问题
- 预计可将 1 小时视频转录时间从"不可用"降至 6-8 分钟

---

*此文档由 Claude Code 自动生成*
