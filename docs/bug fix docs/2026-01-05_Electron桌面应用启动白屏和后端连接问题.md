# Bug Fix: Electron 桌面应用启动白屏和后端连接问题

## 基本信息

| 项目 | 内容 |
|------|------|
| **发现时间** | 2026-01-05 15:54 (UTC+8) |
| **解决时间** | 2026-01-05 17:15 (UTC+8) |
| **修复耗时** | 约 81 分钟 |
| **影响范围** | Electron 桌面应用无法启动，前端完全不可用 |
| **严重程度** | 高 |

---

## Bug 描述

### 现象

1. Electron 桌面应用启动后显示白屏
2. DevTools 控制台显示 React hooks 错误：
   ```
   Invalid hook call. Hooks can only be called inside of the body of a function component.
   Cannot read properties of null (reading 'useEffect')
   ```
3. Library 视频列表不加载
4. API 调用超时，后端无响应

### 复现步骤

1. 在 WSL 中运行 `npm run dev` 启动 Electron 应用
2. 应用窗口打开后显示白屏
3. 打开 DevTools 可以看到 React hooks 错误

---

## 根本原因分析

本次问题涉及多个相互关联的根本原因：

### 原因 1: Electron 开发模式检测失败

`VITE_DEV_SERVER_URL` 环境变量未被 vite-plugin-electron 正确设置，导致 Electron 主进程错误地认为处于生产模式，尝试：
- 启动不存在的 Python 后端
- 加载 `dist/index.html`（开发模式下不存在）

### 原因 2: React 多副本冲突

从 WSL 运行 `npm install` 安装依赖时，创建的符号链接在 Windows 环境下无法正确解析，导致：
- `node_modules/.bin/` 下的所有文件大小为 0
- npm 安装了重复的 React 副本
- React hooks 因检测到多个 React 实例而报错

### 原因 3: 后端进程冲突

存在两个 Python 进程同时监听 8000 端口：
- PID 13604: 新启动的后端 (0.0.0.0:8000)
- PID 34368: 僵尸后端进程 (127.0.0.1:8000)，处于 CLOSE_WAIT 状态

僵尸进程阻止了新连接，导致 API 调用超时。

### 原因 4: WSL/Windows 网络隔离

后端运行在 WSL 中 (IP: 172.30.190.204)，而 Electron 运行在 Windows 中，通过 `127.0.0.1:8000` 无法访问 WSL 的服务。

---

## 修复方案

### 修复 1: 改进 Electron 开发模式检测

**文件**: `electron/main.ts`

```typescript
// 修改前：仅依赖 VITE_DEV_SERVER_URL
const isDev = VITE_DEV_SERVER_URL != null

// 修改后：添加多重检测机制
const isDev = VITE_DEV_SERVER_URL != null ||
              process.env.NODE_ENV === 'development' ||
              !app.isPackaged
```

使用 `app.isPackaged` 作为最可靠的开发模式判断依据。

### 修复 2: 添加开发服务器 URL 回退

**文件**: `electron/main.ts`

```typescript
if (VITE_DEV_SERVER_URL) {
  win.loadURL(VITE_DEV_SERVER_URL)
} else if (!app.isPackaged) {
  // 回退：直接加载 localhost:5173
  const devUrl = 'http://localhost:5173'
  win.loadURL(devUrl)
} else {
  win.loadFile(path.join(RENDERER_DIST, 'index.html'))
}
```

### 修复 3: 从 Windows 端重新安装依赖

在 Windows PowerShell（非 WSL）中执行：

```powershell
cd C:\Users\hancao\.gemini\antigravity\scratch\language-learner\fluent-learner-v2
Remove-Item -Recurse -Force node_modules, package-lock.json
npm install
```

### 修复 4: 终止僵尸进程并从 Windows 启动后端

```powershell
# 终止冲突进程
Stop-Process -Id 34368 -Force
Stop-Process -Id 13604 -Force

# 从 Windows 启动后端
cd C:\...\backend
.\venv\Scripts\python.exe -m uvicorn main:app --host 127.0.0.1 --port 8000
```

---

## 技术要点

### 1. WSL 与 Windows 的网络互通

WSL2 使用虚拟网络，拥有独立 IP 地址。Windows 应用无法通过 `localhost` 访问 WSL 中运行的服务（除非使用 WSL2 的 localhost 转发功能，但这并不总是可靠）。

**最佳实践**: 当 Electron 在 Windows 运行时，确保后端也在 Windows 中运行。

### 2. npm 符号链接问题

在 WSL 中安装的 npm 包使用 Unix 符号链接，这些链接在 Windows NTFS 文件系统上可能无法正确工作，导致可执行文件无法运行。

**最佳实践**: Windows Electron 项目应从 Windows PowerShell/CMD 安装依赖。

### 3. Electron app.isPackaged

`app.isPackaged` 是 Electron 提供的最可靠的开发/生产模式判断属性：
- 开发模式 (`npm run dev`): `false`
- 生产构建: `true`

---

## 验证步骤

1. 在 Windows PowerShell 中启动后端：
   ```powershell
   cd backend
   .\venv\Scripts\python.exe -m uvicorn main:app --host 127.0.0.1 --port 8000
   ```

2. 验证后端可访问：
   ```powershell
   Invoke-RestMethod -Uri 'http://localhost:8000/health'
   # 应返回: status: ok
   ```

3. 从 Windows PowerShell 启动 Electron：
   ```powershell
   cd fluent-learner-v2
   npm run dev
   ```

4. 验证：
   - Electron 窗口正常显示 UI（非白屏）
   - DevTools Console 无 React hooks 错误
   - Library 正常加载视频列表
   - 后端日志显示 `GET /media HTTP/1.1 200 OK`

---

## 相关文件

| 文件 | 修改类型 |
|------|----------|
| `electron/main.ts` | 修改 |
| `node_modules/` | 重新安装 |
| `package-lock.json` | 重新生成 |

---

## 后续优化建议

1. **添加启动脚本**: 创建 `start-dev.ps1` 脚本，自动检查端口占用并启动前后端

2. **端口冲突检测**: 在后端启动时添加端口检测逻辑：
   ```python
   import socket
   def is_port_in_use(port):
       with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
           return s.connect_ex(('localhost', port)) == 0
   ```

3. **开发文档**: 在 README 中明确说明必须从 Windows 端安装依赖和启动服务

4. **环境变量配置**: 考虑在 `package.json` 的 dev 脚本中显式设置 `NODE_ENV=development`
