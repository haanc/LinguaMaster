# Bug Fix: åŒè¯­å­—å¹•æŒ‰éœ€ç¿»è¯‘åŠŸèƒ½æ— æ³•ä½¿ç”¨

## åŸºæœ¬ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **å‘ç°æ—¶é—´** | 2026-01-05 17:26 (UTC+8) |
| **è§£å†³æ—¶é—´** | 2026-01-05 17:44 (UTC+8) |
| **ä¿®å¤è€—æ—¶** | çº¦ 18 åˆ†é’Ÿ |
| **å½±å“èŒƒå›´** | åŒè¯­å­—å¹•åŠŸèƒ½å®Œå…¨ä¸å¯ç”¨ |
| **ä¸¥é‡ç¨‹åº¦** | ä¸­ |

---

## Bug æè¿°

### ç°è±¡

1. ç‚¹å‡»å­—å¹•ä¾§è¾¹æ çš„ç¿»è¯‘æŒ‰é’®ï¼ˆğŸŒï¼‰åæ²¡æœ‰ä»»ä½•ååº”
2. å­—å¹•åŒºåŸŸå§‹ç»ˆåªæ˜¾ç¤ºæºè¯­è¨€å­—å¹•ï¼Œæ— æ³•æ˜¾ç¤ºç¿»è¯‘
3. åˆ‡æ¢ç›®æ ‡è¯­è¨€ä¹Ÿæ— æ•ˆæœ

### å¤ç°æ­¥éª¤

1. å¯åŠ¨ Electron åº”ç”¨å¹¶æ’­æ”¾è§†é¢‘
2. åœ¨å­—å¹•ä¾§è¾¹æ é€‰æ‹©ç›®æ ‡è¯­è¨€ï¼ˆå¦‚ Chineseï¼‰
3. ç‚¹å‡» ğŸŒ æŒ‰é’®å°è¯•å¼€å¯åŒè¯­å­—å¹•
4. è§‚å¯Ÿåˆ°æŒ‰é’®æ— å“åº”ï¼Œç¿»è¯‘æœªæ˜¾ç¤º

---

## æ ¹æœ¬åŸå› åˆ†æ

æœ¬æ¬¡é—®é¢˜æ¶‰åŠä¸¤ä¸ªç›¸äº’å…³è”çš„æ ¹æœ¬åŸå› ï¼š

### åŸå›  1: ç¿»è¯‘åŠŸèƒ½è®¾è®¡é—®é¢˜

åŸå§‹è®¾è®¡å‡è®¾ç¿»è¯‘ä¼šåœ¨è½¬å½•é˜¶æ®µè‡ªåŠ¨å®Œæˆï¼Œä½†å®é™…ä¸Šï¼š
- è½¬å½•æ—¶æ— æ³•ç¡®å®šç”¨æˆ·çš„ç›®æ ‡è¯­è¨€
- `SubtitleSegment` çš„ `translation` å­—æ®µå§‹ç»ˆä¸ºç©º
- å‰ç«¯åªæ˜¯åˆ‡æ¢æ˜¾ç¤º/éšè—ç¿»è¯‘ï¼Œä½†ç¿»è¯‘æ•°æ®ä»æœªç”Ÿæˆ

### åŸå›  2: Azure OpenAI API å‚æ•°ä¸å…¼å®¹

åç«¯ç¿»è¯‘ API è°ƒç”¨ä½¿ç”¨äº† `temperature=0.3` å‚æ•°ï¼Œä½† Azure OpenAI çš„ `gpt-5.2-chat` éƒ¨ç½²ä¸æ”¯æŒæ­¤å‚æ•°å€¼ï¼Œå¯¼è‡´ 500 é”™è¯¯ï¼š

```
'temperature' does not support 0.3 with this model
```

---

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1: å®ç°æŒ‰éœ€ç¿»è¯‘åç«¯æ¥å£

**æ–‡ä»¶**: `backend/main.py`

```python
class TranslateSegmentsRequest(BaseModel):
    segment_ids: List[str]
    target_language: str = "Chinese"

@app.post("/media/{media_id}/translate")
def translate_segments(
    media_id: UUID,
    req: TranslateSegmentsRequest,
    session: Session = Depends(get_session)
):
    """æ‰¹é‡ç¿»è¯‘æŒ‡å®šå­—å¹•æ®µåˆ°ç›®æ ‡è¯­è¨€"""
    segments = session.exec(
        select(SubtitleSegment).where(
            SubtitleSegment.media_id == media_id,
            SubtitleSegment.id.in_([UUID(sid) for sid in req.segment_ids])
        )
    ).all()

    # æ‰¹é‡ç¿»è¯‘å¹¶ä¿å­˜åˆ°æ•°æ®åº“
    texts = [seg.text for seg in segments]
    batch_text = "\n---\n".join([f"[{i}] {t}" for i, t in enumerate(texts)])

    # è°ƒç”¨ AI æœåŠ¡ç¿»è¯‘ï¼ˆå·²ç§»é™¤ temperature å‚æ•°ï¼‰
    response = ai_service.client.chat.completions.create(
        model=deployment,
        messages=[
            {"role": "system", "content": f"Translate to {req.target_language}..."},
            {"role": "user", "content": batch_text}
        ]
    )
    # è§£æå¹¶ä¿å­˜ç¿»è¯‘ç»“æœ
```

æ–°å¢ç«¯ç‚¹æ”¯æŒæ‰¹é‡ç¿»è¯‘ï¼Œä¸€æ¬¡ API è°ƒç”¨ç¿»è¯‘å¤šæ¡å­—å¹•ï¼Œæé«˜æ•ˆç‡ã€‚

### ä¿®å¤ 2: æ·»åŠ å‰ç«¯ API æ–¹æ³•

**æ–‡ä»¶**: `src/services/api.ts`

```typescript
translateSegments: async (
    mediaId: string,
    segmentIds: string[],
    targetLanguage: string
): Promise<{id: string, translation: string}[]> => {
    const response = await axios.post(
        `${API_BASE_URL}/media/${mediaId}/translate`,
        {
            segment_ids: segmentIds,
            target_language: targetLanguage
        }
    );
    return response.data;
}
```

### ä¿®å¤ 3: å®ç°æŒ‰éœ€ç¿»è¯‘è§¦å‘é€»è¾‘

**æ–‡ä»¶**: `src/App.tsx`

```typescript
// é»˜è®¤å…³é—­ç¿»è¯‘æ˜¾ç¤º
const [showTranslation, setShowTranslation] = useState<boolean>(false);
const [isTranslating, setIsTranslating] = useState<boolean>(false);

// ç”¨æˆ·å¯ç”¨åŒè¯­å­—å¹•æ—¶è§¦å‘ç¿»è¯‘
const handleShowTranslationChange = async (show: boolean) => {
    setShowTranslation(show);

    if (show && currentMedia?.id && segments.length > 0) {
        // åªç¿»è¯‘å°šæœªç¿»è¯‘çš„å­—å¹•
        const needsTranslation = segments.filter(s => !s.translation);
        if (needsTranslation.length > 0) {
            setIsTranslating(true);
            try {
                await api.translateSegments(
                    currentMedia.id,
                    needsTranslation.map(s => s.id),
                    targetLanguage
                );
                refetchSegments(); // åˆ·æ–°å­—å¹•æ•°æ®
            } finally {
                setIsTranslating(false);
            }
        }
    }
};

// ç›®æ ‡è¯­è¨€å˜æ›´æ—¶é‡æ–°ç¿»è¯‘
const handleTargetLanguageChange = async (lang: string) => {
    setTargetLanguage(lang);
    if (showTranslation && currentMedia?.id) {
        // é‡æ–°ç¿»è¯‘æ‰€æœ‰å­—å¹•
        await translateAllSegments(lang);
    }
};
```

### ä¿®å¤ 4: æ·»åŠ ç¿»è¯‘åŠ è½½çŠ¶æ€ UI

**æ–‡ä»¶**: `src/components/SubtitleSidebar.tsx`

```typescript
interface SubtitleSidebarProps {
    // ... å…¶ä»–å±æ€§
    isTranslating?: boolean;  // æ–°å¢
}

// æŒ‰é’®æ˜¾ç¤ºåŠ è½½çŠ¶æ€
<button
    className={`translation-toggle ${showTranslation ? 'active' : ''} ${isTranslating ? 'loading' : ''}`}
    onClick={() => onShowTranslationChange(!showTranslation)}
    disabled={isTranslating}
>
    {isTranslating ? 'â³' : 'ğŸŒ'}
</button>
```

### ä¿®å¤ 5: ç§»é™¤ä¸å…¼å®¹çš„ API å‚æ•°

**æ–‡ä»¶**: `backend/main.py`

```python
# ä¿®æ”¹å‰
response = ai_service.client.chat.completions.create(
    model=deployment,
    messages=[...],
    temperature=0.3  # âŒ ä¸å…¼å®¹
)

# ä¿®æ”¹å
response = ai_service.client.chat.completions.create(
    model=deployment,
    messages=[...]  # âœ… ç§»é™¤ temperature å‚æ•°
)
```

---

## æŠ€æœ¯è¦ç‚¹

### 1. æŒ‰éœ€ç¿»è¯‘ vs é¢„ç¿»è¯‘

**ä¸ºä»€ä¹ˆé‡‡ç”¨æŒ‰éœ€ç¿»è¯‘ï¼š**
- è½¬å½•é˜¶æ®µæ— æ³•ç¡®å®šç”¨æˆ·çš„ç›®æ ‡è¯­è¨€
- ç”¨æˆ·å¯èƒ½ä¼šåˆ‡æ¢ç›®æ ‡è¯­è¨€ï¼Œé¢„ç¿»è¯‘ä¼šæµªè´¹èµ„æº
- æŒ‰éœ€ç¿»è¯‘å¯ä»¥å‡å°‘ä¸å¿…è¦çš„ API è°ƒç”¨æˆæœ¬

**å®ç°æ–¹å¼ï¼š**
- å‰ç«¯ç»´æŠ¤ `showTranslation` å’Œ `isTranslating` çŠ¶æ€
- ç”¨æˆ·ç‚¹å‡»æŒ‰é’®æ—¶æ£€æŸ¥å“ªäº›å­—å¹•éœ€è¦ç¿»è¯‘
- åªç¿»è¯‘ `translation` å­—æ®µä¸ºç©ºçš„å­—å¹•
- ç¿»è¯‘å®Œæˆåè°ƒç”¨ `refetchSegments()` åˆ·æ–°æ•°æ®

### 2. æ‰¹é‡ç¿»è¯‘ä¼˜åŒ–

å°†å¤šæ¡å­—å¹•åˆå¹¶ä¸ºä¸€æ¬¡ API è¯·æ±‚ï¼š
```
[0] Hello, how are you?
---
[1] I'm fine, thank you.
---
[2] Nice to meet you.
```

åç«¯è§£æå“åº”æ—¶é€šè¿‡ `[åºå·]` å‰ç¼€åŒ¹é…åŸå§‹å­—å¹•ã€‚

### 3. Azure OpenAI æ¨¡å‹é™åˆ¶

ä¸åŒçš„ Azure OpenAI éƒ¨ç½²å¯¹å‚æ•°æ”¯æŒä¸åŒã€‚`gpt-5.2-chat` å¯èƒ½æ˜¯ç‰¹æ®Šéƒ¨ç½²ï¼Œä¸æ”¯æŒ `temperature` å‚æ•°ã€‚è§£å†³æ–¹æ¡ˆæ˜¯ç§»é™¤è¯¥å‚æ•°ï¼Œä½¿ç”¨æ¨¡å‹é»˜è®¤å€¼ã€‚

---

## éªŒè¯æ­¥éª¤

1. å¯åŠ¨åç«¯æœåŠ¡ï¼š
   ```powershell
   cd backend
   .\venv\Scripts\python.exe -m uvicorn main:app --host 127.0.0.1 --port 8000
   ```

2. å¯åŠ¨ Electron åº”ç”¨ï¼š
   ```powershell
   cd fluent-learner-v2
   npm run dev
   ```

3. éªŒè¯åŠŸèƒ½ï¼š
   - æ’­æ”¾ä¸€ä¸ªè§†é¢‘
   - åœ¨ç›®æ ‡è¯­è¨€ä¸‹æ‹‰æ¡†é€‰æ‹© "Chinese"
   - ç‚¹å‡» ğŸŒ æŒ‰é’®
   - æŒ‰é’®åº”æ˜¾ç¤º â³ åŠ è½½çŠ¶æ€
   - åŠ è½½å®Œæˆåï¼Œæ¯æ¡å­—å¹•ä¸‹æ–¹æ˜¾ç¤ºä¸­æ–‡ç¿»è¯‘
   - åˆ‡æ¢ç›®æ ‡è¯­è¨€ï¼ˆå¦‚ Spanishï¼‰ï¼Œåº”è‡ªåŠ¨é‡æ–°ç¿»è¯‘

4. éªŒè¯ APIï¼š
   ```powershell
   $headers = @{ 'X-Owner-Id' = 'your-owner-id'; 'Content-Type' = 'application/json' }
   $body = '{"segment_ids": ["segment-uuid"], "target_language": "Chinese"}'
   Invoke-RestMethod -Uri 'http://localhost:8000/media/{media_id}/translate' -Method POST -Headers $headers -Body $body
   ```

---

## ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹ç±»å‹ |
|------|----------|
| `backend/main.py` | ä¿®æ”¹ - æ–°å¢ç¿»è¯‘ç«¯ç‚¹ï¼Œç§»é™¤ temperature å‚æ•° |
| `src/services/api.ts` | ä¿®æ”¹ - æ–°å¢ translateSegments æ–¹æ³• |
| `src/App.tsx` | ä¿®æ”¹ - æ–°å¢ç¿»è¯‘çŠ¶æ€ç®¡ç†å’Œè§¦å‘é€»è¾‘ |
| `src/components/SubtitleSidebar.tsx` | ä¿®æ”¹ - æ–°å¢ isTranslating å±æ€§å’ŒåŠ è½½çŠ¶æ€ UI |

---

## åç»­ä¼˜åŒ–å»ºè®®

1. **ç¿»è¯‘ç¼“å­˜**: è€ƒè™‘åœ¨å‰ç«¯ç¼“å­˜å·²ç¿»è¯‘çš„å†…å®¹ï¼Œé¿å…é‡å¤è¯·æ±‚

2. **å¢é‡ç¿»è¯‘**: å½“ç”¨æˆ·æ»šåŠ¨åˆ°æ–°çš„å­—å¹•åŒºåŸŸæ—¶ï¼Œå¯ä»¥å®ç°æ‡’åŠ è½½ç¿»è¯‘

3. **ç¿»è¯‘è¿›åº¦æ˜¾ç¤º**: å¯¹äºé•¿è§†é¢‘ï¼ˆå‡ ç™¾æ¡å­—å¹•ï¼‰ï¼Œå¯ä»¥æ˜¾ç¤ºç¿»è¯‘è¿›åº¦æ¡

4. **é”™è¯¯é‡è¯•**: æ·»åŠ ç¿»è¯‘å¤±è´¥æ—¶çš„è‡ªåŠ¨é‡è¯•æœºåˆ¶

5. **ç¦»çº¿ç¿»è¯‘**: è€ƒè™‘é›†æˆæœ¬åœ°ç¿»è¯‘æ¨¡å‹ï¼ˆå¦‚ LibreTranslateï¼‰ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
